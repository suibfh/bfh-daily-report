<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>BFHãƒ‡ã‚¤ãƒªãƒ¼ãƒ¬ãƒãƒ¼ãƒˆ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: sans-serif; padding: 1em; max-width: 600px; margin: auto; }
    #reportOutput {
      white-space: pre-wrap;
      background: #f9f9f9;
      padding: 1em;
      border-radius: 8px;
      line-height: 1.6;
      border: 1px solid #ccc;
    }
    button {
      padding: 0.6em 1em;
      font-size: 1rem;
      margin-bottom: 1em;
      cursor: pointer;
      border-radius: 5px;
      border: none;
      background-color: #1976d2;
      color: white;
    }
    button:hover {
      background-color: #1565c0;
    }
    small {
      color: gray;
      font-size: 0.85em;
      display: block;
      margin-top: 0.5em;
    }
  </style>
</head>
<body>
  <button onclick="fetchReport()">ğŸ“¢ ãƒ‡ã‚¤ãƒªãƒ¼ãƒ¬ãƒãƒ¼ãƒˆè¡¨ç¤º</button>
  <pre id="reportOutput">ã“ã“ã«ãƒ¬ãƒãƒ¼ãƒˆãŒè¡¨ç¤ºã•ã‚Œã¾ã™</pre>
  <small id="rateDisplay"></small>
  <small id="noticeText"></small>

  <script>
    let lastClicked = 0;

    async function fetchReport() {
      const now = Date.now();
      if (now - lastClicked < 60000) {
        document.getElementById("reportOutput").textContent = "âš ï¸ 1åˆ†ã«1å›ã¾ã§å®Ÿè¡Œå¯èƒ½ã§ã™ã€‚ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„ã€‚";
        return;
      }
      lastClicked = now;

      document.getElementById("reportOutput").textContent = "ğŸ“¡ ãƒ‡ãƒ¼ã‚¿å–å¾—ä¸­...";

      try {
        const jpyData = await fetch("https://suibfh.github.io/bfh-daily-report/usd_jpy.json")
          .then(res => res.json())
          .catch(() => ({ rate: 150, date: null }));

        const usdToJpy = jpyData.rate ?? 150;
        const rateDate = jpyData.date ? new Date(jpyData.date).toLocaleString("ja-JP", { timeZone: "Asia/Tokyo" }) : "ä¸æ˜";

        document.getElementById("rateDisplay").textContent =
          `ç‚ºæ›¿ãƒ¬ãƒ¼ãƒˆï¼š$1 = Â¥${usdToJpy.toFixed(2)}ï¼ˆå–å¾—æ—¥æ™‚ï¼š${rateDate}ï¼‰`;

        const oasUrl = "https://api.coingecko.com/api/v3/simple/price"
          + "?ids=oasys"
          + "&vs_currencies=usd"
          + "&include_24hr_change=true";

        const [coingeckoOAS, geckoBPC] = await Promise.all([
          fetch(oasUrl).then(res => res.json()),
          fetch("https://api.geckoterminal.com/api/v2/networks/oasys/pools/0x53d749ea2507182586b9795ad1435938473d448d").then(res => res.json())
        ]);

        const getBalance = async (rpc, contract, address) => {
          const res = await fetch(rpc, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              jsonrpc: "2.0",
              method: "eth_call",
              params: [{
                to: contract,
                data: "0x70a08231000000000000000000000000" + address.slice(2)
              }, "latest"],
              id: 1
            })
          }).then(res => res.json());
          const hex = res.result || "0x0";
          return parseFloat(parseInt(hex, 16) / 1e18);
        };

        const burnBalance = await getBalance(
          "https://rpc.mainnet.oasys.homeverse.games",
          "0x7c6b91d9be155a6db01f749217d76ff02a7227f2",
          "0x000000000000000000000000000000000000dead"
        );

        const walletBalance = await getBalance(
          "https://rpc.mainnet.oasys.games",
          "0x9a340a0de81b23ecd37ba9c4845dff5850a7e7a4",
          "0x53D749Ea2507182586b9795aD1435938473D448d"
        );

        const oasPrice = coingeckoOAS.oasys.usd;
        const oasChange = coingeckoOAS.oasys.usd_24h_change;

        let bpcPrice = "?";
        let bpcChange = "?";
        try {
          bpcPrice = parseFloat(geckoBPC.data.attributes.base_token_price_usd).toFixed(5);
          bpcChange = parseFloat(geckoBPC.data.attributes.price_change_percentage.h24).toFixed(2);
        } catch (e) {
          console.log("âš ï¸ BPCä¾¡æ ¼ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
        }

        const tweet = `ğŸ“˜ã€BFHãƒ‡ã‚¤ãƒªãƒ¼ãƒ¬ãƒãƒ¼ãƒˆã€‘
ğŸ”¥ BPCãƒãƒ¼ãƒ³ç·é‡ï¼š${Math.floor(burnBalance).toLocaleString()} BPC
ğŸ’° Tealswapãƒ—ãƒ¼ãƒ«ä¿æœ‰é‡ï¼š${Math.floor(walletBalance).toLocaleString()} BPC
ğŸ’ BPCä¾¡æ ¼ï¼š$${bpcPrice}ï¼ˆÂ¥${(bpcPrice * usdToJpy).toFixed(2)} / 24h ${bpcChange}%ï¼‰
ğŸ’ OASä¾¡æ ¼ï¼š$${oasPrice.toFixed(5)}ï¼ˆÂ¥${(oasPrice * usdToJpy).toFixed(2)} / 24h ${oasChange.toFixed(2)}%ï¼‰
#BPC #OAS #ãƒ–ãƒ¬ãƒ’ãƒ­`;

        document.getElementById("reportOutput").textContent = tweet;
        document.getElementById("noticeText").textContent = "â€»ã“ã®æƒ…å ±ã¯å½“ã‚µã‚¤ãƒˆãŒå–å¾—ã—ãŸæœ€æ–°ãƒ‡ãƒ¼ã‚¿ã§ã™ã€‚å…¬å¼ç™ºè¡¨ã¨ã¯ç•°ãªã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚";

      } catch (e) {
        document.getElementById("reportOutput").textContent = "âŒ ãƒ‡ãƒ¼ã‚¿å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ™‚é–“ã‚’ãŠã„ã¦å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚";
        document.getElementById("noticeText").textContent = "";
        document.getElementById("rateDisplay").textContent = "";
      }
    }
  </script>
</body>
</html>
